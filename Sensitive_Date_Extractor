from burp import IBurpExtender
from burp import IHttpListener
from burp import IScanIssue
from java.net import URL
import re

class BurpExtender(IBurpExtender, IHttpListener):
    def registerExtenderCallbacks(self, callbacks):
        self._callbacks = callbacks
        self._helpers = callbacks.getHelpers()
        callbacks.setExtensionName("Sensitive Data Extractor")
        callbacks.registerHttpListener(self)
        self._reported_issues = set()

    def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):
        if not messageIsRequest:
            response = messageInfo.getResponse()
            analyzed_response = self._helpers.analyzeResponse(response)

            patterns = {
                'password': r'(?i)(password|pass|passwd)\W+\w+',
                'google_api': r'AIza[0-9A-Za-z-_]{35}',
                'firebase': r'AAAA[A-Za-z0-9_-]{7}:[A-Za-z0-9_-]{140}',
                'google_captcha': r'6L[0-9A-Za-z-_]{38}|^6[0-9a-zA-Z_-]{39}$'
            }

            matched_data = {}
            for key, pattern in patterns.items():
                regex = re.compile(pattern)
                matches = re.findall(regex, self._helpers.bytesToString(response))
                if matches:
                    matched_data[key] = matches

            if matched_data:
                issue_url = str(messageInfo.getUrl())
                
                if issue_url in self._reported_issues:
                    return
                
                self._reported_issues.add(issue_url)

                issue_details = "<br>".join(["%s: %s" % (key, ', '.join(matches)) for key, matches in matched_data.items()])
                issue = CustomScanIssue(messageInfo.getHttpService(),
                                        self._helpers.analyzeRequest(messageInfo).getUrl(),
                                        [messageInfo],
                                        "Sensitive Data Disclosure",
                                        "The response contains the following sensitive data:<br>%s" % issue_details,
                                        "High")
                self._callbacks.addScanIssue(issue)

class CustomScanIssue(IScanIssue):
    def __init__(self, httpService, url, httpMessages, name, detail, severity):
        self._httpService = httpService
        self._url = url
        self._httpMessages = httpMessages
        self._name = name
        self._detail = detail
        self._severity = severity

    def getUrl(self):
        return self._url

    def getIssueName(self):
        return self._name

    def getIssueType(self):
        return 0

    def getSeverity(self):
        return self._severity

    def getConfidence(self):
        return "Certain"

    def getIssueBackground(self):
	    return None

    def getRemediationBackground(self):
        return None

    def getIssueDetail(self):
        return self._detail

    def getRemediationDetail(self):
        return None

    def getHttpMessages(self):
        return self._httpMessages

    def getHttpService(self):
        return self._httpService
